<div id="party-builder" class="pb-wrap">
  <h2>Build Your Party Package</h2>

  <!-- STICKY TOTAL (always visible) -->
  <div class="pb-sticky" id="pbStickyTotal">
    <div class="pb-sticky-inner">
      <div>
        <div class="pb-sticky-label">ESTIMATED TOTAL</div>
        <div class="pb-sticky-hint">Updates as you pick options</div>
      </div>
      <div class="pb-sticky-value" id="pbStickyTotalValue">$0</div>
      <button type="button" class="pb-btn pb-btn-primary" id="pbStickyReviewBtn">Review / Send</button>
    </div>
  </div>

  <!-- STEP 1: DURATION -->
  <div class="pb-card">
    <h3 class="pb-title">CHOOSE YOUR PARTY LENGTH</h3>

    <label class="pb-option">
      <input type="radio" name="pbDuration" value="60 min" data-key="60">
      <span><strong>60 min</strong></span>
    </label>

    <label class="pb-option">
      <input type="radio" name="pbDuration" value="90 min" data-key="90">
      <span><strong>90 min</strong></span>
    </label>

    <label class="pb-option">
      <input type="radio" name="pbDuration" value="2 hours" data-key="120">
      <span><strong>2 hours</strong></span>
    </label>

    <label class="pb-option">
      <input type="radio" name="pbDuration" value="3 hours" data-key="180">
      <span><strong>3 hours</strong></span>
    </label>
  </div>

  <!-- STEP 2: ENTERTAINERS -->
  <div class="pb-card pb-hiddenblock" id="pbStepEntertainers">
    <h3 class="pb-title">CHOOSE ENTERTAINERS</h3>

    <label class="pb-field pb-field-inline">
      How many entertainers?
      <select id="pbEntertainers">
        <option value="" selected disabled>Choose…</option>
        <option value="1">1 entertainer</option>
        <option value="2">2 entertainers</option>
      </select>
      <div class="pb-mini" id="pbPriceLine">Select entertainers to see price.</div>
    </label>
  </div>

  <!-- STEP 3: INCLUDED ACTIVITIES -->
  <div class="pb-card pb-hiddenblock" id="pbStepIncluded">
    <h3 class="pb-title">CHOOSE INCLUDED ACTIVITY (1 PER ENTERTAINER)</h3>

    <div class="pb-activity-grid" id="pbIncludedGrid">
      <!-- injected by JS -->
    </div>
  </div>

  <!-- STEP 4: ADD-ON ACTIVITIES -->
  <div class="pb-card pb-hiddenblock" id="pbStepAddons">
    <h3 class="pb-title">ADD-ONS</h3>

    <div id="pbAddonList">
      <!-- injected by JS -->
    </div>
  </div>

  <!-- KIDS (dropdown + subtitle) -->
  <div class="pb-card pb-hiddenblock" id="pbStepKids">
    <h3 class="pb-title">APPROX. NUMBER OF KIDS</h3>
    <div class="pb-subtitle">(Just give it your best guess!)</div>

    <label class="pb-field pb-field-inline">
      <select id="pbKidsSelect">
        <option value="" selected disabled>Choose…</option>
        <option value="Up to 10 kids">Up to 10 kids</option>
        <option value="11–15 kids">11–15 kids</option>
        <option value="16–20 kids">16–20 kids</option>
        <option value="21–25 kids">21–25 kids</option>
        <option value="26–30 kids">26–30 kids</option>
        <option value="31+ kids">31+ kids</option>
      </select>
    </label>
  </div>

  <!-- DETAILS (always visible) -->
  <div class="pb-card" id="pbDetails">
    <h3 class="pb-title">PARTY DETAILS</h3>

    <div class="pb-grid">
      <label class="pb-field">
        Your Name
        <input type="text" id="pbName" placeholder="Wonder Woman" required>
      </label>

      <label class="pb-field">
        Email
        <input type="email" id="pbEmail" placeholder="wonder@woman.com" required>
      </label>

      <label class="pb-field">
        Party Date
        <input type="date" id="pbDate">
      </label>

      <label class="pb-field">
        Location
        <input type="text" id="pbLocation" placeholder="Address or city" required>
      </label>
    </div>

    <!-- Travel fees note -->
    <div class="pb-travel">
      <strong>Travel Fees:</strong> Travel fees may apply depending on your location. We’ll confirm your final total after reviewing the address.
    </div>

    <label class="pb-field">
      Notes (optional)
      <textarea id="pbNotes" rows="3" placeholder="Theme, ages, special requests..."></textarea>
    </label>
  </div>

  <!-- TOTAL + ACTIONS (always visible) -->
  <div class="pb-total" id="pbActions">
    <div>
      <div class="pb-total-label">Estimated Total</div>
      <div class="pb-total-value" id="pbTotal">$0</div>
      <div class="pb-fineprint">Final total may change with travel, custom requests, or weekend/holiday rates.</div>

      <!-- ✅ COUPON CODE -->
      <label class="pb-field" style="max-width:320px;margin-top:12px;">
        Coupon Code
        <input type="text" id="pbCoupon" placeholder="Enter coupon code">
        <div class="pb-mini" id="pbCouponMsg"></div>
      </label>
    </div>

    <div class="pb-actions">
      <button type="button" class="pb-btn" id="pbDownload">Download Summary</button>
      <button type="button" class="pb-btn pb-btn-primary" id="pbEmailBtn">Email This Request</button>
    </div>
  </div>

  <div class="pb-hidden">
    <textarea id="pbSummary"></textarea>
  </div>
</div>

<style>
  /* ====== MAIN BACKGROUND (NO BALLOONS) ====== */
  html, body{
    height: 100%;
    margin: 0;
    background: #5792B6;
  }

  #party-builder.pb-wrap{
    max-width:820px;
    margin:0 auto;
    font-family:inherit;

    /* keep wrapper clean (no balloon layers) */
    background: transparent;
    padding:22px 14px 26px;
    position:relative;
    border-radius:20px;
  }

  /* ====== WHITE “BOXES” (cards + totals) ====== */
  .pb-card{
    border:1px solid rgba(0,0,0,.12);
    border-radius:16px;
    padding:18px;
    margin:14px 0;
    background:#fff;
  }

  .pb-total{
    display:flex;
    justify-content:space-between;
    gap:16px;
    align-items:center;
    border:1px solid rgba(0,0,0,.12);
    border-radius:16px;
    padding:18px;
    margin-top:14px;
    background:#fff;
  }

  /* Sticky bar stays white too */
  .pb-sticky-inner{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    padding:12px 14px;
    border:1px solid rgba(0,0,0,.12);
    border-radius:16px;
    background:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
  }

  /* Form controls: keep white background */
  .pb-field input,
  .pb-field textarea,
  .pb-field select{
    padding:10px 12px;
    border:1px solid rgba(0,0,0,.2);
    border-radius:12px;
    font:inherit;
    background:#fff;
  }

  /* ====== KEEP YOUR EXISTING STYLES BELOW (unchanged) ====== */
  .pb-title{letter-spacing:.08em;text-transform:uppercase;font-size:.95rem;margin:0 0 10px 0;opacity:.85}
  .pb-option{display:flex;gap:12px;align-items:flex-start;padding:10px 10px;border-radius:12px;cursor:pointer}
  .pb-option:hover{background:rgba(0,0,0,.04)}
  .pb-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pb-field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .pb-field-inline{max-width:360px}
  .pb-mini{font-size:.85rem;opacity:.7;margin-top:8px;line-height:1.35}
  .pb-subtitle{font-size:.9rem;opacity:.7;margin-top:-4px;margin-bottom:10px}
  .pb-total-label{font-size:.95rem;opacity:.7}
  .pb-total-value{font-size:2rem;font-weight:700;line-height:1.1}
  .pb-fineprint{font-size:.85rem;opacity:.7;margin-top:6px;max-width:420px}
  .pb-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .pb-btn{padding:10px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.2);background:#fff;cursor:pointer}
  .pb-btn:hover{filter:brightness(0.95)}
  .pb-btn-primary{background:#EE6067;color:#fff;border-color:#EE6067}
  .pb-hidden{display:none}
  .pb-hiddenblock{display:none}
  @media (max-width:640px){
    .pb-grid{grid-template-columns:1fr}
    .pb-total{flex-direction:column;align-items:flex-start}
  }

  /* Sticky total wrapper positioning */
  .pb-sticky{position: sticky;top: 10px;z-index: 999;margin: 10px 0 14px 0;}
  .pb-sticky-label{letter-spacing:.08em;text-transform:uppercase;font-size:.8rem;opacity:.7}
  .pb-sticky-hint{font-size:.85rem;opacity:.65;margin-top:2px}
  .pb-sticky-value{font-size:1.3rem;font-weight:800;margin-left:auto;margin-right:10px;white-space:nowrap}

  /* Activities layout */
  .pb-activity-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px;}
  @media (max-width:640px){.pb-activity-grid{grid-template-columns:1fr}}
  .pb-activity-card{border:1px solid rgba(0,0,0,.12);border-radius:14px;padding:12px;background:#fff}
  .pb-activity-head{font-weight:700;margin-bottom:8px;}
  .pb-addon-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid rgba(0,0,0,.12);border-radius:12px;margin:8px 0;background:#fff}
  .pb-addon-item:hover{background:rgba(0,0,0,.03)}

  /* Travel note */
  .pb-travel{
    margin-top:12px;
    padding:12px;
    border:1px dashed rgba(0,0,0,.25);
    border-radius:12px;
    font-size:.9rem;
    opacity:.85;
    line-height:1.35;
    background:#fff;
  }
</style>

<script>
(function(){
  const el = (id)=>document.getElementById(id);
  const durationRadios = () => Array.from(document.querySelectorAll('input[name="pbDuration"]'));

  function money(n){ return `$${Number(n || 0).toFixed(0)}`; }

  // Pricing table
  const PRICE_TABLE = {
    60:  {1: 150, 2: 250},
    90:  {1: 200, 2: 350},
    120: {1: 250, 2: 450},
    180: {1: 350, 2: 650}
  };

  const ACTIVITIES = [
    "Balloon Twisting",
    "Face Painting",
    "Character Appearances",
    "Magic Show & Crowning Ceremony",
    "Games & Dancing"
  ];

  const ADDON_ACTIVITY_PRICE = 40;
  const PHOTOGRAPHER_PRICE = 175;

  // ✅ COUPON SETTINGS (case-insensitive)
  const COUPON_CODE = "magic2026";
  const COUPON_DISCOUNT = 0.10; // 10%

  function showBlock(id, show){
    const node = el(id);
    if(!node) return;
    node.style.display = show ? "block" : "none";
  }

  function getSelectedDurationMinutes(){
    const dur = durationRadios().find(r => r.checked);
    return dur ? Number(dur.dataset.key || 0) : 0;
  }

  function getDurationLabel(minutes){
    if(minutes === 60) return "60 min";
    if(minutes === 90) return "90 min";
    if(minutes === 120) return "2 hours";
    if(minutes === 180) return "3 hours";
    return "—";
  }

  function getEntertainers(){
    const v = el('pbEntertainers').value;
    return v ? Number(v) : 0;
  }

  function packagePrice(minutes, entertainers){
    if(!minutes || !entertainers) return 0;
    return (PRICE_TABLE[minutes] && PRICE_TABLE[minutes][entertainers]) ? PRICE_TABLE[minutes][entertainers] : 0;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function buildIncludedUI(entertainers){
    const grid = el('pbIncludedGrid');
    grid.innerHTML = "";

    for(let i=1; i<=entertainers; i++){
      const card = document.createElement('div');
      card.className = "pb-activity-card";
      card.innerHTML = `
        <div class="pb-activity-head">Entertainer ${i} — Included Activity</div>
        <label class="pb-field">
          <select class="pb-included" data-ent="${i}">
            <option value="" selected disabled>Choose…</option>
            ${ACTIVITIES.map(a => `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join("")}
          </select>
        </label>
      `;
      grid.appendChild(card);
    }

    Array.from(document.querySelectorAll('.pb-included')).forEach(sel => {
      sel.addEventListener('change', function(){
        rebuildAddonList();
        updateVisibilityAfterIncluded();
        calcTotal();
      });
    });

    rebuildAddonList();
    calcTotal();
  }

  function getIncludedSelections(){
    const sels = Array.from(document.querySelectorAll('.pb-included'));
    return sels.map(s => s.value).filter(Boolean);
  }

  function rebuildAddonList(){
    const holder = el('pbAddonList');
    holder.innerHTML = "";

    const included = new Set(getIncludedSelections());

    // Activity add-ons ($40 each), excluding included selections
    ACTIVITIES.forEach(act => {
      if(included.has(act)) return;

      const wrap = document.createElement('label');
      wrap.className = "pb-addon-item";
      wrap.innerHTML = `
        <input type="checkbox" class="pb-addon" value="${escapeHtml(act)}" data-price="${ADDON_ACTIVITY_PRICE}">
        <span><strong>${escapeHtml(act)}</strong> — <span style="opacity:.7">${money(ADDON_ACTIVITY_PRICE)}</span></span>
      `;
      holder.appendChild(wrap);
    });

    // Photographer add-on (always available)
    const photo = document.createElement('label');
    photo.className = "pb-addon-item";
    photo.innerHTML = `
      <input type="checkbox" class="pb-addon" value="1 hr Photographer" data-price="${PHOTOGRAPHER_PRICE}">
      <span><strong>1 hr Photographer</strong> — <span style="opacity:.7">${money(PHOTOGRAPHER_PRICE)}</span></span>
    `;
    holder.appendChild(photo);

    Array.from(document.querySelectorAll('.pb-addon')).forEach(cb => {
      cb.addEventListener('change', calcTotal);
    });
  }

  function allIncludedChosen(){
    const ent = getEntertainers();
    if(!ent) return false;
    const included = Array.from(document.querySelectorAll('.pb-included')).map(s => s.value);
    return included.length === ent && included.every(v => !!v);
  }

  function updateVisibilityAfterDuration(){
    const minutes = getSelectedDurationMinutes();
    showBlock('pbStepEntertainers', !!minutes);

    if(!minutes){
      el('pbEntertainers').value = "";
      showBlock('pbStepIncluded', false);
      showBlock('pbStepAddons', false);
      showBlock('pbStepKids', false);
      el('pbIncludedGrid').innerHTML = "";
      el('pbAddonList').innerHTML = "";
      el('pbKidsSelect').value = "";
    }
  }

  function updateVisibilityAfterEntertainers(){
    const minutes = getSelectedDurationMinutes();
    const ent = getEntertainers();

    showBlock('pbStepIncluded', !!(minutes && ent));
    showBlock('pbStepAddons', false);
    showBlock('pbStepKids', false);

    if(minutes && ent){
      buildIncludedUI(ent);
    } else {
      el('pbIncludedGrid').innerHTML = "";
      el('pbAddonList').innerHTML = "";
      el('pbKidsSelect').value = "";
    }
  }

  function updateVisibilityAfterIncluded(){
    const ok = allIncludedChosen();
    showBlock('pbStepAddons', ok);
    showBlock('pbStepKids', ok);
  }

  function getAddonTotal(){
    const addons = Array.from(document.querySelectorAll('.pb-addon')).filter(c => c.checked);
    return addons.reduce((sum,c)=> sum + Number(c.dataset.price || 0), 0);
  }

  function calcTotal(){
    const minutes = getSelectedDurationMinutes();
    const ent = getEntertainers();

    const pkg = packagePrice(minutes, ent);
    const addonTotal = getAddonTotal();
    let subtotal = pkg + addonTotal;

    // ✅ Coupon apply (case-insensitive)
    const couponInput = el('pbCoupon');
    const couponMsg = el('pbCouponMsg');
    let discount = 0;

    if(couponInput){
      const code = couponInput.value.trim().toLowerCase();

      if(code){
        if(code === COUPON_CODE){
          discount = subtotal * COUPON_DISCOUNT;
          if(couponMsg){
            couponMsg.textContent = "✔ Coupon applied (10% off)";
            couponMsg.style.color = "green";
          }
        } else {
          if(couponMsg){
            couponMsg.textContent = "✖ Invalid coupon code";
            couponMsg.style.color = "#c00";
          }
        }
      } else {
        if(couponMsg) couponMsg.textContent = "";
      }
    }

    const total = subtotal - discount;

    el('pbTotal').textContent = money(total);
    el('pbStickyTotalValue').textContent = money(total);

    if(minutes && ent){
      el('pbPriceLine').textContent = `Selected package price: ${money(pkg)}`;
    } else if(minutes && !ent){
      el('pbPriceLine').textContent = `Select entertainers to see price.`;
    } else {
      el('pbPriceLine').textContent = `Select duration to begin.`;
    }

    el('pbSummary').value = buildSummary({ minutes, ent, pkg, addonTotal, discount, total });
    return total;
  }

  function buildSummary(ctx){
    const name = el('pbName').value.trim();
    const email = el('pbEmail').value.trim();
    const date = el('pbDate').value;
    const location = el('pbLocation').value.trim();
    const notes = el('pbNotes').value.trim();

    const kidsLabel = el('pbKidsSelect').value || "—";
    const durLabel = getDurationLabel(ctx.minutes);
    const entertainersLabel = ctx.ent ? `${ctx.ent} entertainer${ctx.ent === 1 ? "" : "s"}` : "—";

    const included = Array.from(document.querySelectorAll('.pb-included')).map((s, idx) => ({
      idx: idx+1,
      value: s.value
    })).filter(x => x.value);

    const includedLines = included.length
      ? included.map(x => `- Entertainer ${x.idx}: ${x.value}`)
      : ["- None selected"];

    const addons = Array.from(document.querySelectorAll('.pb-addon')).filter(c => c.checked);
    const addonLines = addons.length
      ? addons.map(a => `- ${a.value} (${money(Number(a.dataset.price || 0))})`)
      : ["- None"];

    const couponText = el('pbCoupon') ? el('pbCoupon').value.trim() : "";
    const couponApplied = couponText && couponText.trim().toLowerCase() === COUPON_CODE;

    const lines = [];
    lines.push("PARTY PACKAGE REQUEST");
    lines.push("—".repeat(28));
    lines.push(`Name: ${name || "—"}`);
    lines.push(`Email: ${email || "—"}`);
    if(date) lines.push(`Party Date: ${date}`);
    lines.push(`Location: ${location || "—"}`);
    lines.push("");

    lines.push(`Duration: ${durLabel}`);
    lines.push(`Entertainers: ${entertainersLabel}`);
    lines.push(`Package Price: ${money(ctx.pkg)}`);

    lines.push("");
    lines.push("Included Activities:");
    includedLines.forEach(l => lines.push(l));

    lines.push("");
    lines.push(`Approx. Kids: ${kidsLabel}`);

    lines.push("");
    lines.push("Add-Ons:");
    addonLines.forEach(l => lines.push(l));

    lines.push("");
    lines.push(`Add-On Total: ${money(ctx.addonTotal)}`);

    // ✅ Coupon line(s) in summary
    if(couponText){
      lines.push(`Coupon Code: ${couponText}${couponApplied ? " (applied)" : " (invalid)"}`);
    } else {
      lines.push(`Coupon Code: —`);
    }
    if(ctx.discount && ctx.discount > 0){
      lines.push(`Discount: -${money(ctx.discount)}`);
    }

    lines.push(`Estimated Total: ${money(ctx.total)}`);
    lines.push("");
    lines.push("Travel Fees: Travel fees may apply depending on your location. We’ll confirm your final total after reviewing the address.");
    lines.push("");
    if(notes){
      lines.push("Notes:");
      lines.push(notes);
      lines.push("");
    }
    lines.push("Submitted from the website package builder.");

    return lines.join("\n");
  }

  function validateBasics(){
    const name = el('pbName').value.trim();
    const email = el('pbEmail').value.trim();
    const location = el('pbLocation').value.trim();

    if(!name || !email || !location){
      alert("Please enter your name, email, and location so we can send you the summary.");
      return false;
    }
    return true;
  }

  function downloadSummary(){
    if(!validateBasics()) return;
    calcTotal();
    const summary = el('pbSummary').value;

    const blob = new Blob([summary], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "party-package-summary.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  function emailSummary(){
    if(!validateBasics()) return;
    calcTotal();
    const summary = el('pbSummary').value;

    const to = "events@magicinthemaking.net";
    const subject = encodeURIComponent("Party Package Request (Website)");
    const body = encodeURIComponent(summary);

    window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
  }

  // Wire duration step
  durationRadios().forEach(r => {
    r.addEventListener('change', function(){
      updateVisibilityAfterDuration();
      calcTotal();
    });
  });

  // Wire entertainers step
  el('pbEntertainers').addEventListener('change', function(){
    updateVisibilityAfterEntertainers();
    calcTotal();
  });

  // Kids dropdown update
  el('pbKidsSelect').addEventListener('change', calcTotal);

  // ✅ Coupon typing updates total live
  el('pbCoupon')?.addEventListener('input', calcTotal);

  // Review button scroll
  el('pbStickyReviewBtn').addEventListener('click', function(){
    el('pbActions').scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  // Actions
  el('pbDownload').addEventListener('click', downloadSummary);
  el('pbEmailBtn').addEventListener('click', emailSummary);

  // Initial state
  showBlock('pbStepEntertainers', false);
  showBlock('pbStepIncluded', false);
  showBlock('pbStepAddons', false);
  showBlock('pbStepKids', false);
  calcTotal();
})();
</script>
